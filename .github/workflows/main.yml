name: Ecomerg Daily Reports

on:
  schedule:
    - cron: '0 10 * * *'  # Daily at 1 PM Kuwait time (10 AM UTC)
  workflow_dispatch:  # Allow manual trigger

jobs:
  generate-report:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install requests pandas
    
    - name: Generate and send report
      env:
        GOOGLE_SHEET_URL: ${{ secrets.GOOGLE_SHEET_URL }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        python3 << 'EOF'
        import requests
        import pandas as pd
        import os
        from datetime import datetime
        
        def send_telegram_message(bot_token, chat_id, message):
            url = f"https://api.telegram.org/bot{bot_token}/sendMessage"
            data = {
                "chat_id": chat_id,
                "text": message,
                "parse_mode": "Markdown"
            }
            response = requests.post(url, data=data)
            return response.json()
        
        def get_sheet_data():
            try:
                # Extract sheet ID from URL
                sheet_url = os.environ['GOOGLE_SHEET_URL']
                sheet_id = sheet_url.split('/d/')[1].split('/')[0]
                
                # Read the sheet as CSV (public access)
                csv_url = f"https://docs.google.com/spreadsheets/d/{sheet_id}/export?format=csv&gid=0"
                df = pd.read_csv(csv_url)
                
                return df
            except Exception as e:
                print(f"Error reading sheet: {e}")
                return None
        
        def generate_report():
            df = get_sheet_data()
            if df is None:
                return "âŒ **Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª**\n\nÙ„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø¨ÙŠØ§Ù†Ø§Øª Google Sheet"
            
            # Get today's date
            today = datetime.now().strftime('%Y-%m-%d')
            
            # Generate report
            report = f"ğŸ“Š **ØªÙ‚Ø±ÙŠØ± Ecomerg Ø§Ù„ÙŠÙˆÙ…ÙŠ**\n"
            report += f"ğŸ“… **Ø§Ù„ØªØ§Ø±ÙŠØ®:** {today}\n\n"
            
            # Basic statistics
            total_rows = len(df)
            report += f"ğŸ“ˆ **Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª:** {total_rows}\n"
            
            # If there are specific columns, analyze them
            if not df.empty:
                columns = df.columns.tolist()
                report += f"ğŸ“‹ **Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…ØªØ§Ø­Ø©:** {len(columns)}\n"
                
                # Show first few column names
                if len(columns) > 0:
                    report += f"ğŸ“ **Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©:** {', '.join(columns[:5])}\n"
                    if len(columns) > 5:
                        report += f"... Ùˆ {len(columns) - 5} Ø£Ø¹Ù…Ø¯Ø© Ø£Ø®Ø±Ù‰\n"
                
                # Look for common e-commerce columns
                if 'Orders' in columns:
                    if pd.api.types.is_numeric_dtype(df['Orders']):
                        total_orders = df['Orders'].sum()
                        report += f"ğŸ›’ **Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª:** {total_orders}\n"
                
                if 'Revenue' in columns:
                    if pd.api.types.is_numeric_dtype(df['Revenue']):
                        total_revenue = df['Revenue'].sum()
                        report += f"ğŸ’° **Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª:** {total_revenue:.2f} KWD\n"
            
            report += f"\nâœ… **ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ:** {datetime.now().strftime('%H:%M:%S')}"
            
            return report
        
        # Main execution
        try:
            print("ğŸš€ Ø¨Ø¯Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ...")
            
            # Generate report
            report_message = generate_report()
            
            # Send to Telegram
            bot_token = os.environ['TELEGRAM_BOT_TOKEN']
            chat_id = os.environ['TELEGRAM_CHAT_ID']
            
            result = send_telegram_message(bot_token, chat_id, report_message)
            
            if result.get('ok'):
                print("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­!")
            else:
                print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±: {result}")
        
        except Exception as e:
            error_message = f"âŒ **Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…**\n\n```\n{str(e)}\n```"
            try:
                send_telegram_message(os.environ['TELEGRAM_BOT_TOKEN'], os.environ['TELEGRAM_CHAT_ID'], error_message)
            except:
                pass
            print(f"âŒ Ø®Ø·Ø£: {e}")
        EOF

