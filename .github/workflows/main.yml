name: Ecomerg Daily Reports

on:
  schedule:
    - cron: '0 10 * * *'  # Daily at 1 PM Kuwait time (10 AM UTC)
  workflow_dispatch:  # Allow manual trigger

jobs:
  generate-report:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install requests pandas
    
    - name: Generate and send report
      env:
        GOOGLE_SHEET_URL: ${{ secrets.GOOGLE_SHEET_URL }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        python3 << 'EOF'
        import requests
        import pandas as pd
        import os
        from datetime import datetime, timedelta
        
        def send_telegram_message(bot_token, chat_id, message):
            url = f"https://api.telegram.org/bot{bot_token}/sendMessage"
            data = {
                "chat_id": chat_id,
                "text": message,
                "parse_mode": "Markdown"
            }
            response = requests.post(url, data=data)
            return response.json()
        
        def get_sheet_data():
            try:
                # Extract sheet ID from URL
                sheet_url = os.environ['GOOGLE_SHEET_URL']
                sheet_id = sheet_url.split('/d/')[1].split('/')[0]
                
                # Read the sheet as CSV (public access)
                csv_url = f"https://docs.google.com/spreadsheets/d/{sheet_id}/export?format=csv&gid=0"
                df = pd.read_csv(csv_url)
                
                return df
            except Exception as e:
                print(f"Error reading sheet: {e}")
                return None
        
        def format_number(num):
            """Format numbers with proper Arabic formatting"""
            if pd.isna(num) or num == 0:
                return "0"
            if num >= 1000:
                return f"{num:,.0f}"
            elif num >= 1:
                return f"{num:.1f}"
            else:
                return f"{num:.2f}"
        
        def get_performance_emoji(value, threshold_good=80, threshold_ok=60):
            """Get performance emoji based on value"""
            if pd.isna(value):
                return "âšª"
            if value >= threshold_good:
                return "ğŸŸ¢"
            elif value >= threshold_ok:
                return "ğŸŸ¡"
            else:
                return "ğŸ”´"
        
        def generate_report():
            df = get_sheet_data()
            if df is None:
                return "âŒ **Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª**\n\nÙ„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø¨ÙŠØ§Ù†Ø§Øª Google Sheet"
            
            if df.empty:
                return "ğŸ“Š **ØªÙ‚Ø±ÙŠØ± Ecomerg Ø§Ù„ÙŠÙˆÙ…ÙŠ**\n\nâš ï¸ **Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø©**"
            
            # Get today's date
            today = datetime.now().strftime('%Y-%m-%d')
            yesterday = (datetime.now() - timedelta(days=1)).strftime('%Y-%m-%d')
            
            # Generate report header
            report = f"ğŸ“Š **ØªÙ‚Ø±ÙŠØ± Ecomerg Ø§Ù„ÙŠÙˆÙ…ÙŠ**\n"
            report += f"ğŸ“… **Ø§Ù„ØªØ§Ø±ÙŠØ®:** {today}\n"
            report += f"â° **ÙˆÙ‚Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ±:** {datetime.now().strftime('%H:%M:%S')}\n\n"
            
            # Get latest data (assuming last row is most recent)
            latest_data = df.iloc[-1] if len(df) > 0 else None
            
            if latest_data is not None:
                # Orders Summary
                report += "ğŸ›’ **Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨Ø§Øª:**\n"
                
                if 'ğŸ›’ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©' in df.columns:
                    new_orders = latest_data.get('ğŸ›’ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©', 0)
                    report += f"â€¢ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©: {format_number(new_orders)}\n"
                
                if 'âœ… ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…' in df.columns:
                    delivered = latest_data.get('âœ… ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…', 0)
                    report += f"â€¢ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…: {format_number(delivered)}\n"
                
                if 'âŒ Ù…Ù„ØºÙŠ' in df.columns:
                    cancelled = latest_data.get('âŒ Ù…Ù„ØºÙŠ', 0)
                    report += f"â€¢ Ù…Ù„ØºÙŠ: {format_number(cancelled)}\n"
                
                if 'â¸ï¸ Ù…Ø¹Ù„Ù‚' in df.columns:
                    pending = latest_data.get('â¸ï¸ Ù…Ø¹Ù„Ù‚', 0)
                    report += f"â€¢ Ù…Ø¹Ù„Ù‚: {format_number(pending)}\n"
                
                report += "\n"
                
                # Financial Summary
                report += "ğŸ’° **Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ:**\n"
                
                if 'ğŸ’° Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©' in df.columns:
                    budget = latest_data.get('ğŸ’° Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©', 0)
                    report += f"â€¢ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©: {format_number(budget)} Ø¯.Ùƒ\n"
                
                if 'ğŸ’° Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙØ¹Ù„ÙŠØ©' in df.columns:
                    revenue = latest_data.get('ğŸ’° Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙØ¹Ù„ÙŠØ©', 0)
                    report += f"â€¢ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙØ¹Ù„ÙŠØ©: {format_number(revenue)} Ø¯.Ùƒ\n"
                
                if 'ğŸ’µ Ø³Ø¹Ø± Ø§Ù„Ø·Ù„Ø¨' in df.columns:
                    order_price = latest_data.get('ğŸ’µ Ø³Ø¹Ø± Ø§Ù„Ø·Ù„Ø¨', 0)
                    report += f"â€¢ Ø³Ø¹Ø± Ø§Ù„Ø·Ù„Ø¨: {format_number(order_price)} Ø¯.Ùƒ\n"
                
                if 'ğŸ’ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ' in df.columns:
                    real_price = latest_data.get('ğŸ’ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ', 0)
                    report += f"â€¢ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ: {format_number(real_price)} Ø¯.Ùƒ\n"
                
                report += "\n"
                
                # Performance Metrics
                report += "ğŸ“ˆ **Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡:**\n"
                
                if 'ğŸ“‰ Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ù„ØºØ§Ø¡ %' in df.columns:
                    cancel_rate = latest_data.get('ğŸ“‰ Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ù„ØºØ§Ø¡ %', 0)
                    emoji = get_performance_emoji(100 - cancel_rate, 90, 80)
                    report += f"â€¢ Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ù„ØºØ§Ø¡: {format_number(cancel_rate)}% {emoji}\n"
                
                if 'ğŸ“ˆ Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„ %' in df.columns:
                    conversion_rate = latest_data.get('ğŸ“ˆ Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„ %', 0)
                    emoji = get_performance_emoji(conversion_rate, 5, 3)
                    report += f"â€¢ Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„: {format_number(conversion_rate)}% {emoji}\n"
                
                if 'ğŸ’¸ ROAS' in df.columns:
                    roas = latest_data.get('ğŸ’¸ ROAS', 0)
                    emoji = get_performance_emoji(roas, 3, 2)
                    report += f"â€¢ ROAS: {format_number(roas)} {emoji}\n"
                
                if 'ğŸ¯ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù…' in df.columns:
                    overall_performance = latest_data.get('ğŸ¯ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù…', 0)
                    emoji = get_performance_emoji(overall_performance, 80, 60)
                    report += f"â€¢ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù…: {format_number(overall_performance)}% {emoji}\n"
                
                report += "\n"
                
                # Weekly Summary (if we have enough data)
                if len(df) >= 7:
                    report += "ğŸ“Š **Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù…Ø§Ø¶ÙŠ:**\n"
                    
                    # Get last 7 days data
                    last_week = df.tail(7)
                    
                    if 'ğŸ›’ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©' in df.columns:
                        weekly_orders = last_week['ğŸ›’ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©'].sum()
                        report += f"â€¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: {format_number(weekly_orders)}\n"
                    
                    if 'ğŸ’° Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙØ¹Ù„ÙŠØ©' in df.columns:
                        weekly_revenue = last_week['ğŸ’° Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙØ¹Ù„ÙŠØ©'].sum()
                        report += f"â€¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª: {format_number(weekly_revenue)} Ø¯.Ùƒ\n"
                    
                    if 'ğŸ“ˆ Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„ %' in df.columns:
                        avg_conversion = last_week['ğŸ“ˆ Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„ %'].mean()
                        report += f"â€¢ Ù…ØªÙˆØ³Ø· Ø§Ù„ØªØ­ÙˆÙŠÙ„: {format_number(avg_conversion)}%\n"
                    
                    report += "\n"
            
            # Data Quality Check
            total_rows = len(df)
            report += f"ğŸ“‹ **Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:**\n"
            report += f"â€¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: {total_rows}\n"
            report += f"â€¢ Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: {datetime.now().strftime('%d/%m/%Y %H:%M')}\n"
            
            # Footer
            report += f"\nâœ… **ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­**\n"
            report += f"ğŸ¤– **Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ - Ecomerg**"
            
            return report
        
        # Main execution
        try:
            print("ğŸš€ Ø¨Ø¯Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø§Ù„Ù…Ø­Ø³Ù†...")
            
            # Generate report
            report_message = generate_report()
            
            # Send to Telegram
            bot_token = os.environ['TELEGRAM_BOT_TOKEN']
            chat_id = os.environ['TELEGRAM_CHAT_ID']
            
            result = send_telegram_message(bot_token, chat_id, report_message)
            
            if result.get('ok'):
                print("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­!")
                print(f"ğŸ“¨ Message ID: {result.get('result', {}).get('message_id', 'N/A')}")
            else:
                print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±: {result}")
        
        except Exception as e:
            error_message = f"âŒ **Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…**\n\n```\n{str(e)}\n```"
            try:
                send_telegram_message(os.environ['TELEGRAM_BOT_TOKEN'], os.environ['TELEGRAM_CHAT_ID'], error_message)
            except:
                pass
            print(f"âŒ Ø®Ø·Ø£: {e}")
        EOF

