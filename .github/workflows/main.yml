name: Ecomerg Daily Reports

on:
  schedule:
    - cron: '0 10 * * *'  # Daily at 1 PM Kuwait time (10 AM UTC)
  workflow_dispatch:  # Allow manual trigger

jobs:
  generate-report:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install requests pandas
    
    - name: Generate and send report
      env:
        GOOGLE_SHEET_URL: ${{ secrets.GOOGLE_SHEET_URL }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        python3 << 'EOF'
        import requests
        import pandas as pd
        import os
        from datetime import datetime
        
        def send_telegram_message(bot_token, chat_id, message):
            url = f"https://api.telegram.org/bot{bot_token}/sendMessage"
            data = {
                "chat_id": chat_id,
                "text": message,
                "parse_mode": "Markdown"
            }
            response = requests.post(url, data=data)
            return response.json()
        
        def get_sheet_data():
            try:
                # Extract sheet ID from URL
                sheet_url = os.environ['GOOGLE_SHEET_URL']
                sheet_id = sheet_url.split('/d/')[1].split('/')[0]
                
                # Read the sheet as CSV (public access)
                csv_url = f"https://docs.google.com/spreadsheets/d/{sheet_id}/export?format=csv&gid=0"
                df = pd.read_csv(csv_url)
                
                return df
            except Exception as e:
                print(f"Error reading sheet: {e}")
                return None
        
        def get_status_emoji(team_name, cancel_rate, delivered, new_orders):
            """Get status emoji based on performance"""
            if delivered == 0 and new_orders > 0:
                return "ğŸš¨"  # No deliveries yet
            elif cancel_rate > 10:
                return "âš ï¸"  # High cancel rate
            else:
                return "âœ…"  # Good performance
        
        def get_rank_emoji(rank):
            """Get rank emoji"""
            rank_emojis = {
                1: "ğŸ¥‡", 2: "ğŸ¥ˆ", 3: "ğŸ¥‰", 4: "4ï¸âƒ£", 5: "5ï¸âƒ£",
                6: "6ï¸âƒ£", 7: "7ï¸âƒ£", 8: "8ï¸âƒ£", 9: "9ï¸âƒ£", 10: "ğŸ”Ÿ"
            }
            return rank_emojis.get(rank, f"{rank}ï¸âƒ£")
        
        def format_number(num):
            """Format numbers with proper formatting"""
            if pd.isna(num) or num == 0:
                return "0"
            if isinstance(num, str):
                try:
                    num = float(num)
                except:
                    return str(num)
            
            if num >= 1000:
                return f"{num:,.0f}"
            elif num >= 1:
                return f"{num:.1f}"
            else:
                return f"{num:.2f}"
        
        def generate_report():
            df = get_sheet_data()
            if df is None:
                return "âŒ **Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª**\n\nÙ„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø¨ÙŠØ§Ù†Ø§Øª Google Sheet"
            
            if df.empty:
                return "ğŸ“Š **ØªÙ‚Ø±ÙŠØ± Ecomerg Ø§Ù„ÙŠÙˆÙ…ÙŠ**\n\nâš ï¸ **Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø©**"
            
            # Get today's date
            today = datetime.now().strftime('%d/%m/%Y')
            
            # Generate report header
            report = f"ğŸ”¥ **Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø°ÙƒÙŠ - {today}**\n"
            report += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
            report += "âœ… **Ø§Ù„ÙØ±Ù‚ Ø§Ù„Ù†Ø´Ø·Ø©:**\n"
            
            # Process data
            teams_data = []
            total_orders = 0
            total_delivered = 0
            total_cancelled = 0
            total_budget = 0
            complete_teams = 0
            incomplete_teams = 0
            
            for index, row in df.iterrows():
                try:
                    team_name = str(row.get('Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©', 'Unknown'))
                    new_orders = float(row.get('ğŸ›’ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©', 0)) if pd.notna(row.get('ğŸ›’ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©', 0)) else 0
                    delivered = float(row.get('âœ… ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…', 0)) if pd.notna(row.get('âœ… ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…', 0)) else 0
                    cancelled = float(row.get('âŒ Ù…Ù„ØºÙŠ', 0)) if pd.notna(row.get('âŒ Ù…Ù„ØºÙŠ', 0)) else 0
                    hold = float(row.get('â¸ï¸ Ù…Ø¹Ù„Ù‚', 0)) if pd.notna(row.get('â¸ï¸ Ù…Ø¹Ù„Ù‚', 0)) else 0
                    budget = float(row.get('ğŸ’° Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©', 0)) if pd.notna(row.get('ğŸ’° Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©', 0)) else 0
                    
                    # Calculate metrics
                    total_processed = delivered + cancelled
                    cancel_rate = (cancelled / total_processed * 100) if total_processed > 0 else 0
                    order_price = (budget / new_orders) if new_orders > 0 else 0
                    target = delivered - cancelled  # Simple target calculation
                    
                    # Determine status
                    status_emoji = get_status_emoji(team_name, cancel_rate, delivered, new_orders)
                    
                    # Check if data is complete
                    if new_orders > 0 or delivered > 0 or cancelled > 0:
                        complete_teams += 1
                    else:
                        incomplete_teams += 1
                    
                    teams_data.append({
                        'team': team_name,
                        'new_orders': new_orders,
                        'delivered': delivered,
                        'cancelled': cancelled,
                        'hold': hold,
                        'budget': budget,
                        'cancel_rate': cancel_rate,
                        'order_price': order_price,
                        'target': target,
                        'status': status_emoji
                    })
                    
                    # Add to totals
                    total_orders += new_orders
                    total_delivered += delivered
                    total_cancelled += cancelled
                    total_budget += budget
                    
                except Exception as e:
                    print(f"Error processing row {index}: {e}")
                    continue
            
            # Sort teams by new orders (descending)
            teams_data.sort(key=lambda x: x['new_orders'], reverse=True)
            
            # Generate team reports
            for rank, team in enumerate(teams_data, 1):
                if team['new_orders'] == 0 and team['delivered'] == 0 and team['cancelled'] == 0:
                    # Incomplete data
                    report += f"{get_rank_emoji(rank)} **{team['team']} âš ï¸**\n"
                    report += "âš ï¸ **Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©**\n"
                    report += "ğŸ“¦ New Orders: 0\n"
                    report += "ğŸšš Delivered: 0\n"
                    report += "âŒ Cancel: 0\n"
                    report += "â³ Hold: 0\n"
                    report += "ğŸ’¸ Budget: 0\n"
                    report += "ğŸ¯ Target: +0\n"
                    report += "ğŸ’° Order Price: 0.00\n"
                    report += "ğŸ“Š Cancel Rate: 0.0%\n"
                else:
                    # Complete data
                    target_sign = "+" if team['target'] >= 0 else ""
                    report += f"{get_rank_emoji(rank)} **{team['team']} {team['status']}**\n"
                    report += f"ğŸ“¦ New Orders: {format_number(team['new_orders'])}\n"
                    report += f"ğŸšš Delivered: {format_number(team['delivered'])}\n"
                    report += f"âŒ Cancel: {format_number(team['cancelled'])}\n"
                    report += f"â³ Hold: {format_number(team['hold'])}\n"
                    report += f"ğŸ’¸ Budget: {format_number(team['budget'])}\n"
                    report += f"ğŸ¯ Target: {target_sign}{format_number(team['target'])}\n"
                    report += f"ğŸ’° Order Price: {format_number(team['order_price'])}\n"
                    report += f"ğŸ“Š Cancel Rate: {team['cancel_rate']:.1f}%\n"
                
                report += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
            
            # Generate summary
            total_processed = total_delivered + total_cancelled
            overall_cancel_rate = (total_cancelled / total_processed * 100) if total_processed > 0 else 0
            delivery_rate = (total_delivered / total_processed * 100) if total_processed > 0 else 0
            avg_order_price = (total_budget / total_orders) if total_orders > 0 else 0
            
            report += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
            report += f"ğŸ“Š **Ù…Ù„Ø®Øµ {today}:**\n"
            report += f"âœ… ÙØ±Ù‚ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§Ù…Ù„Ø©: {complete_teams}/{len(teams_data)}\n"
            report += f"âš ï¸ ÙØ±Ù‚ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©: {incomplete_teams}\n"
            report += f"âŒ ÙØ±Ù‚ Ø¨Ø¯ÙˆÙ† Ø¨ÙŠØ§Ù†Ø§Øª: 0\n"
            report += f"ğŸ“¦ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: {format_number(total_orders)}\n"
            report += f"ğŸšš Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³Ù„Ù…: {format_number(total_delivered)}\n"
            report += f"âŒ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù„ØºÙŠ: {format_number(total_cancelled)}\n"
            report += f"ğŸ’¸ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©: {format_number(total_budget)}\n"
            report += f"ğŸ’° Ù…ØªÙˆØ³Ø· Ø³Ø¹Ø± Ø§Ù„Ø·Ù„Ø¨: {format_number(avg_order_price)}\n"
            report += f"ğŸ“ˆ Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ³Ù„ÙŠÙ…: {delivery_rate:.1f}%\n"
            report += f"ğŸ“‰ Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ù„ØºØ§Ø¡: {overall_cancel_rate:.1f}%\n"
            
            return report
        
        # Main execution
        try:
            print("ğŸš€ Ø¨Ø¯Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ...")
            
            # Generate report
            report_message = generate_report()
            
            # Send to Telegram
            bot_token = os.environ['TELEGRAM_BOT_TOKEN']
            chat_id = os.environ['TELEGRAM_CHAT_ID']
            
            result = send_telegram_message(bot_token, chat_id, report_message)
            
            if result.get('ok'):
                print("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­!")
                print(f"ğŸ“¨ Message ID: {result.get('result', {}).get('message_id', 'N/A')}")
            else:
                print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±: {result}")
        
        except Exception as e:
            error_message = f"âŒ **Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…**\n\n```\n{str(e)}\n```"
            try:
                send_telegram_message(os.environ['TELEGRAM_BOT_TOKEN'], os.environ['TELEGRAM_CHAT_ID'], error_message)
            except:
                pass
            print(f"âŒ Ø®Ø·Ø£: {e}")
        EOF

